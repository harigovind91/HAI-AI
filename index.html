import os, sqlite3, requests, json
from flask import Flask, request, jsonify, render_template_string, session, redirect, url_for
from werkzeug.security import generate_password_hash, check_password_hash
import stripe

app = Flask(__name__)
app.secret_key = "HARI_SOVEREIGN_CLEAN_2026"

# --- ‚öôÔ∏è ‡§Ö‡§∏‡§≤‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ---
stripe.api_key = os.environ.get("STRIPE_LIVE_KEY")
GEMINI_KEY = os.environ.get("GEMINI_API_KEY") # [cite: 2026-01-14] HAI Intelligence
MASTER_KEY = "HARI-2026-REDEEMED-XYZ-99" # [cite: 2026-01-16] Master Security Key

# --- üóÑÔ∏è DATABASE ---
def init_db():
    conn = sqlite3.connect('hai_sovereign_pro.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users 
                 (email TEXT PRIMARY KEY, password TEXT, plan TEXT DEFAULT 'FREE')''')
    conn.commit()
    conn.close()

init_db()

# --- üé® UI: ‡§ï‡•ç‡§≤‡•Ä‡§® ‡§î‡§∞ ‡§∏‡•Ä‡§ï‡•ç‡§∞‡•á‡§ü (Front-end code cleaned) ---
UI_LAYOUT = """
<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAI | Sovereign Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hai-gradient { background: linear-gradient(135deg, #FF3030, #007AFF, #34C759); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="antialiased">
    <nav class="p-5 glass flex justify-between items-center px-10">
        <h1 class="text-2xl font-black hai-gradient">HAI</h1>
        <div>
            {% if session.user %}
                <button class="text-[10px] bg-zinc-800 px-4 py-1 rounded-full text-zinc-400 uppercase tracking-tighter">{{ session.user }}</button>
            {% else %}
                <a href="/auth" class="text-xs font-bold text-blue-500">LOGIN</a>
            {% endif %}
        </div>
    </nav>

    <main class="flex-1 flex flex-col items-center justify-center p-6">
        <div id="chat-container" class="w-full max-w-3xl flex flex-col gap-4">
            <div id="box" class="h-[60vh] overflow-y-auto p-6 space-y-6 font-medium text-sm">
                <div class="text-zinc-500">‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•à‡§Ç HAI ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§®, ‡§ü‡•Ç‡§≤, ‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞ ‡§Ø‡§æ ‡§Ü‡§∞‡•ç‡§ü ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§™‡•Ç‡§õ‡§ø‡§è...</div>
            </div>
            
            <div id="paywall" class="hidden glass p-6 rounded-3xl border border-blue-500/50 text-center animate-bounce">
                <p class="text-sm font-bold mb-3">Professional Task Detected: This service requires a PRO Subscription.</p>
                <button onclick="window.location.href='/checkout'" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-bold">UPGRADE NOW (‚Çπ1,580)</button>
            </div>

            <div class="glass p-2 rounded-[30px] flex items-center pr-4">
                <input id="q" class="flex-1 bg-transparent p-4 outline-none text-lg" placeholder="‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç...">
                <button onclick="ask()" class="bg-blue-600 p-4 rounded-2xl"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        async function ask() {
            const q = document.getElementById('q'); const box = document.getElementById('box');
            const paywall = document.getElementById('paywall');
            if(!q.value) return;
            
            box.innerHTML += `<div class="text-right text-zinc-400 font-normal ml-auto max-w-[80%]">${q.value}</div>`;
            const val = q.value; q.value = "";
            paywall.classList.add('hidden'); // Reset paywall on new ask

            const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({p: val}) });
            const data = await res.json();
            
            if(data.status === 'UPGRADE') {
                paywall.classList.remove('hidden');
            } else {
                box.innerHTML += `<div class="text-blue-500 max-w-[90%]">> HAI: ${data.r}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
"""

# --- üöÄ LOGIC: ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ---
@app.route('/chat', methods=['POST'])
def chat():
    user_p = request.json.get('p').lower()
    plan = session.get('plan', 'FREE')
    
    # [cite: 2026-01-27] ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞‡•ç‡§∏
    pro_triggers = [
        'design', 'website', 'app', 'tool', 'software', 'art', 'video', 
        'blueprint', 'cad', 'code', 'develop', 'architecture', 'legal'
    ]
    
    # ‡§Ö‡§ó‡§∞ ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡§æ‡§Æ ‡§Æ‡§æ‡§Ç‡§ó ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§µ‡•ã ‡§™‡•ç‡§∞‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
    if any(word in user_p for word in pro_triggers) and plan == 'FREE':
        return jsonify({"status": "UPGRADE"})

    # ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¨‡§æ‡§§‡§ö‡•Ä‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è Gemini API
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={GEMINI_KEY}"
    try:
        r = requests.post(url, json={"contents":[{"parts":[{"text": user_p}]}]}).json()
        reply = r['candidates'][0]['content']['parts'][0]['text']
        return jsonify({"r": reply, "status": "OK"})
    except:
        return jsonify({"r": "Service Node busy. Try again."})

# --- üí≥ STRIPE: ‡§Ö‡§∏‡§≤‡•Ä ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ---
@app.route('/checkout')
def checkout():
    if not session.get('user'): return redirect('/auth')
    checkout_session = stripe.checkout.Session.create(
        payment_method_types=['card', 'upi'],
        line_items=[{'price_data': {'currency': 'inr', 'product_data': {'name': 'HAI PRO ACCESS'}, 'unit_amount': 158000}, 'quantity': 1}],
        mode='payment',
        success_url=url_for('payment_success', _external=True),
        cancel_url=url_for('home', _external=True)
    )
    return redirect(checkout_session.url)

@app.route('/payment-success')
def payment_success():
    email = session.get('user')
    conn = sqlite3.connect('hai_sovereign_pro.db')
    c = conn.cursor()
    c.execute("UPDATE users SET plan='PRO' WHERE email=?", (email,))
    conn.commit()
    conn.close()
    session['plan'] = 'PRO'
    return redirect('/')

@app.route('/')
def home():
    return render_template_string(UI_LAYOUT)

@app.route('/auth', methods=['GET', 'POST'])
def auth():
    # Login/Signup logic (Same as before but with better UI)
    if request.method == 'POST':
        email, pw = request.form.get('email'), request.form.get('pass')
        conn = sqlite3.connect('hai_sovereign_pro.db')
        c = conn.cursor()
        c.execute("SELECT password, plan FROM users WHERE email=?", (email,))
        user = c.fetchone()
        if user and check_password_hash(user[0], pw):
            session['user'], session['plan'] = email, user[1]
            return redirect('/')
        elif not user:
            c.execute("INSERT INTO users (email, password) VALUES (?, ?)", (email, generate_password_hash(pw)))
            conn.commit()
            session['user'], session['plan'] = email, 'FREE'
            return redirect('/')
        conn.close()
    return render_template_string("<form method='POST'>Signup/Login Form Here</form>")

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)
    
