import os, sqlite3, requests, json
from flask import Flask, request, jsonify, render_template_string, session, redirect, url_for
from werkzeug.security import generate_password_hash, check_password_hash
import stripe

app = Flask(__name__)
app.secret_key = "HARI_SOVEREIGN_CLEAN_2026"

# --- ‚öôÔ∏è ‡§Ö‡§∏‡§≤‡•Ä ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ (‡§Ö‡§¶‡•É‡§∂‡•ç‡§Ø ‡§î‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§) ---
stripe.api_key = os.environ.get("STRIPE_LIVE_KEY")
GEMINI_KEY = os.environ.get("GEMINI_API_KEY") #
MASTER_KEY = "HARI-2026-REDEEMED-XYZ-99" #

# --- üóÑÔ∏è DATABASE ---
def init_db():
    conn = sqlite3.connect('hai_sovereign_pro.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users 
                 (email TEXT PRIMARY KEY, password TEXT, plan TEXT DEFAULT 'FREE')''')
    conn.commit()
    conn.close()

init_db()

# --- üé® UI: ‡§ï‡•ç‡§≤‡•Ä‡§® ‡§î‡§∞ ‡§∏‡•Ä‡§ï‡•ç‡§∞‡•á‡§ü (Front-end code cleaned) ---
UI_LAYOUT = """
<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAI | Sovereign Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hai-gradient { background: linear-gradient(135deg, #FF3030, #007AFF, #34C759); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .glass { background: rgba(255,255,255,0.02); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.05); }
        #box::-webkit-scrollbar { width: 4px; }
        #box::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">
    <nav class="p-5 glass flex justify-between items-center px-10">
        <h1 class="text-2xl font-black hai-gradient">HAI</h1>
        <div>
            {% if session.user %}
                <button class="text-[10px] bg-zinc-900 px-4 py-1 rounded-full text-zinc-500 uppercase">{{ session.user.split('@')[0] }}</button>
            {% else %}
                <a href="/auth" class="text-xs font-bold text-zinc-400 hover:text-white transition">‡§™‡•ç‡§∞‡§µ‡•á‡§∂</a>
            {% endif %}
        </div>
    </nav>

    <main class="flex-1 flex flex-col items-center justify-end p-6 pb-12">
        <div id="chat-container" class="w-full max-w-2xl flex flex-col gap-6">
            <div id="box" class="overflow-y-auto max-h-[65vh] space-y-6 pr-2">
                <div class="text-zinc-600 text-sm">‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?</div>
            </div>
            
            <div id="paywall" class="hidden glass p-8 rounded-[35px] border border-blue-500/30 text-center scale-95 transition-all">
                <h3 class="text-lg font-bold mb-2">‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§∏‡•á‡§µ‡§æ ‡§ï‡§æ ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ</h3>
                <p class="text-zinc-500 text-xs mb-6">‡§°‡§ø‡§ú‡§æ‡§á‡§®, ‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞ ‡§î‡§∞ ‡§ï‡§≤‡§æ‡§§‡•ç‡§Æ‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡•ã ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§</p>
                <button onclick="window.location.href='/checkout'" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-2xl text-xs font-black transition">‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç (‚Çπ1,580)</button>
            </div>

            <div class="glass p-2 rounded-[32px] flex items-center pr-3 border border-zinc-800 focus-within:border-zinc-700 transition">
                <input id="q" class="flex-1 bg-transparent p-4 outline-none text-base placeholder-zinc-700" placeholder="‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç ‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡•å‡§Ç‡§™‡•á‡§Ç...">
                <button onclick="ask()" class="bg-zinc-100 text-black p-3 rounded-2xl hover:bg-white transition"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        async function ask() {
            const q = document.getElementById('q'); const box = document.getElementById('box');
            const paywall = document.getElementById('paywall');
            if(!q.value) return;
            
            box.innerHTML += `<div class="text-right text-zinc-300 font-normal ml-auto max-w-[85%] bg-zinc-900/50 p-4 rounded-3xl rounded-tr-none">${q.value}</div>`;
            const val = q.value; q.value = "";
            paywall.classList.add('hidden'); 

            const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({p: val}) });
            const data = await res.json();
            
            if(data.status === 'UPGRADE') {
                paywall.classList.remove('hidden');
                box.scrollTop = box.scrollHeight;
            } else {
                box.innerHTML += `<div class="text-blue-500 max-w-[90%] font-medium leading-relaxed">> HAI: ${data.r}</div>`;
                box.scrollTop = box.scrollHeight;
            }
        }
    </script>
</body>
</html>
"""

# --- üöÄ LOGIC: ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ (On-Demand Paywall) ---
@app.route('/chat', methods=['POST'])
def chat():
    user_p = request.json.get('p').lower()
    plan = session.get('plan', 'FREE')
    
    # ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•Ä ‡§™‡§π‡§ö‡§æ‡§®
    pro_triggers = [
        'design', 'website', 'app', 'tool', 'software', 'art', 'video', 
        'blueprint', 'cad', 'code', 'develop', 'architecture', 'legal',
        '‡§°‡§ø‡§ú‡§æ‡§á‡§®', '‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü', '‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞', '‡§®‡§ï‡•ç‡§∂‡§æ', '‡§ï‡•ã‡§°'
    ]
    
    # ‡§Æ‡§æ‡§Ç‡§ó ‡§™‡§∞ ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§ï‡•Ä ‡§Æ‡§æ‡§Ç‡§ó
    if any(word in user_p for word in pro_triggers) and plan == 'FREE':
        return jsonify({"status": "UPGRADE"})

    # ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§Ç‡§µ‡§æ‡§¶
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={GEMINI_KEY}"
    try:
        r = requests.post(url, json={"contents":[{"parts":[{"text": user_p}]}]}).json()
        reply = r['candidates'][0]['content']['parts'][0]['text']
        return jsonify({"r": reply, "status": "OK"})
    except:
        return jsonify({"r": "‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‡§µ‡•ç‡§Ø‡§∏‡•ç‡§§ ‡§π‡•à‡•§ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "status": "ERROR"})

# --- üí≥ STRIPE: ‡§Ö‡§∏‡§≤‡•Ä ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ---
@app.route('/checkout')
def checkout():
    if not session.get('user'): return redirect('/auth')
    checkout_session = stripe.checkout.Session.create(
        payment_method_types=['card', 'upi'],
        line_items=[{'price_data': {'currency': 'inr', 'product_data': {'name': 'HAI PRO ACCESS'}, 'unit_amount': 158000}, 'quantity': 1}],
        mode='payment',
        success_url=url_for('payment_success', _external=True),
        cancel_url=url_for('home', _external=True)
    )
    return redirect(checkout_session.url)

@app.route('/payment_success')
def payment_success():
    email = session.get('user')
    conn = sqlite3.connect('hai_sovereign_pro.db')
    c = conn.cursor()
    c.execute("UPDATE users SET plan='PRO' WHERE email=?", (email,))
    conn.commit()
    conn.close()
    session['plan'] = 'PRO'
    return redirect('/')

@app.route('/')
def home():
    return render_template_string(UI_LAYOUT)

@app.route('/auth', methods=['GET', 'POST'])
def auth():
    if request.method == 'POST':
        email, pw = request.form.get('email'), request.form.get('pass')
        conn = sqlite3.connect('hai_sovereign_pro.db')
        c = conn.cursor()
        c.execute("SELECT password, plan FROM users WHERE email=?", (email,))
        user = c.fetchone()
        if user and check_password_hash(user[0], pw):
            session['user'], session['plan'] = email, user[1]
            return redirect('/')
        elif not user:
            c.execute("INSERT INTO users (email, password) VALUES (?, ?)", (email, generate_password_hash(pw)))
            conn.commit()
            session['user'], session['plan'] = email, 'FREE'
            return redirect('/')
        conn.close()
    return render_template_string("")

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)
    
